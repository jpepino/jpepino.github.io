<script type="text/javascript">
    // Basic setup boilerplate for using VexFlow with the SVG rendering context:
    VF = Vex.Flow;

    // Create an SVG renderer and attach it to the DIV element named "boo".
    var div = document.getElementById("boo")
    var renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);

    // Configure the rendering context.
    renderer.resize(1000, 500);
    renderer.ctx.setViewBox(0, 0, 500, 250);
    var context = renderer.getContext();

    // A tickContext is required to draw anything that would be placed
    // in relation to time/rhythm, including StaveNote which we use here.
    // In real music, this allows VexFlow to align notes from multiple
    // voices with different rhythms horizontally. Here, it doesn't do much
    // for us, since we'll be animating the horizontal placement of notes,
    // but we still need to add our notes to a tickContext so that they get
    // an x value and can be rendered.
    //
    // If we create a voice, it will automatically apply a tickContext to our
    // notes, and space them relative to each other based on their duration &
    // the space available. We definitely do not want that here! So, instead
    // of creating a voice, we handle that part of the drawing manually.
    var tickContext = new VF.TickContext();

    // Create a stave of width 10000 at position 10, 40 on the canvas.
    var stave = new VF.Stave(10, 10, 10000)
        .addClef('treble');

    // Connect it to the rendering context and draw!
    stave.setContext(context).draw();

    var durations = ['8', '4', '2', '1'];

    var notes = [
        ['c', '', '4'],
        ['d', '', '4'],
        ['e', '', '4'],
        ['f', '', '4'],
        ['g', '', '4'],
        ['a', '', '4'],
        ['b', '', '4'],
        ['c', '', '5']
    ].map(([letter, acc, octave]) => {
        const note = new VF.StaveNote({
            clef: 'treble',
            keys: [`${letter}${acc}/${octave}`],
            duration: durations[Math.floor(Math.random() * durations.length)],
        })
            .setContext(context)
            .setStave(stave);

        // If a StaveNote has an accidental, we must render it manually.
        // This is so that you get full control over whether to render
        // an accidental depending on the musical context. Here, if we
        // have one, we want to render it. (Theoretically, we might
        // add logic to render a natural sign if we had the same letter
        // name previously with an accidental. Or, perhaps every twelfth
        // note or so we might render a natural sign randomly, just to be
        // sure our user who's learning to read accidentals learns
        // what the natural symbol means.)
        if (acc) note.addAccidental(0, new VF.Accidental(acc));
        tickContext.addTickable(note)
        return note;
    });

    // The tickContext.preFormat() call assigns x-values (and other
    // formatting values) to notes. It must be called after we've
    // created the notes and added them to the tickContext. Or, it
    // can be called each time a note is added, if the number of
    // notes needed is not known at the time of bootstrapping.
    //
    // To see what happens if you put it in the wrong place, try moving
    // this line up to where the TickContext is initialized, and check
    // out the error message you get.
    //
    // tickContext.setX() establishes the left-most x position for all
    // of the 'tickables' (notes, etc...) in a context.
    tickContext.preFormat().setX(400);

    // This will contain any notes that are currently visible on the staff,
    // before they've either been answered correctly, or plumetted off
    // the staff when a user fails to answer them correctly in time.
    // TODO: Add sound effects.
    const visibleNoteGroups = [];
    const visibleNotes = [];

    var score = 0;

    // Add a note to the staff from the notes array (if there are any left).
    function addNote() {
        var randVal = Math.floor(Math.random() * notes.length);
        note = notes[randVal];
        visibleNotes.push(convert(randVal));
        if (!note) return;
        const group = context.openGroup();
        visibleNoteGroups.push(group);
        note.draw();
        context.closeGroup();
        group.classList.add('scroll');
        // Force a dom-refresh by asking for the group's bounding box. Why? Most
        // modern browsers are smart enough to realize that adding .scroll class
        // hasn't changed anything about the rendering, so they wait to apply it
        // at the next dom refresh, when they can apply any other changes at the
        // same time for optimization. However, if we allow that to happen,
        // then sometimes the note will immediately jump to its fully transformed
        // position -- because the transform will be applied before the class with
        // its transition rule.
        const box = group.getBoundingClientRect();
        group.classList.add('scrolling');

        // If a user doesn't answer in time make the note fall below the staff
        window.setTimeout(() => {
            const index = visibleNoteGroups.indexOf(group);
            if (index === -1) return;
            group.classList.add('too-slow');
            visibleNoteGroups.shift();
            visibleNotes.shift();
            updateScore(-10);
        }, 5000);
    }

    var timer;

    function startGame() {
        timer = setInterval(addNote, 1500);
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;
    }

    function stopGame() {
        clearInterval(timer);
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled = true;
    }

    function playSound(var note) {
        var audio = document.getElementById("audio");
        audio.play();
    }

    function guessNote(guess) {
        playSound(guess);
        if(guess == visibleNotes[0]){
            group = visibleNoteGroups.shift();
            group.classList.add('correct');
            const transformMatrix = window.getComputedStyle(group).transform;
            const x = transformMatrix.split(',')[4].trim();
            group.style.transform = `translate(${x}px, -800px)`;
            updateScore(10);
        }
        else if(guess != visibleNotes[0]){
            group = visibleNoteGroups.shift();
            group.classList.add('too-slow');
            updateScore(-10);
        }
        visibleNotes.shift();
    }

    function updateScore(val) {
        score += val;
        document.getElementById("score").innerHTML = "<b>Score: " + score + "</b>";
    }

    function convert(val) {
        if(val==0 || val==7){
            return 'c';
        }
        if(val==1){
            return 'd';
        }
        if(val==2){
            return 'e';
        }
        if(val==3){
            return 'f';
        }
        if(val==4){
            return 'g';
        }
        if(val==5){
            return 'a';
        }
        if(val==6){
            return 'b';
        }
    }

    window.onbeforeunload = function () {
            stopGame();
    };

</script>

<div id="myCarousel" class="carousel slide">
    <!-- Indicators -->
    <ol class="carousel-indicators">
        <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
        <li data-target="#myCarousel" data-slide-to="1"></li>
        <li data-target="#myCarousel" data-slide-to="2"></li>
    </ol>

    <!-- Wrapper for slides -->
    <div class="carousel-inner">
        <div class="item active">
            <div class="fill" style="background-image:url('http://placehold.it/1900x1080&text=Specialists');"></div>
            <div class="carousel-caption">
                <h1>Reduce costs of finishing operations by 65%</h1>
            </div>
        </div>
        <div class="item">
            <div class="fill" style="background-image:url('http://placehold.it/1900x1080&text=Wordlwide');"></div>
            <div class="carousel-caption">
                <h1>International Buyer Financing Available</h1>
            </div>
        </div>
        <div class="item">
            <div class="fill" style="background-image:url('http://placehold.it/1900x1080&text=Since 1910');"></div>
            <div class="carousel-caption">
                <h1>Family Owned for Four Generations</h1>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <a class="left carousel-control" href="#myCarousel" data-slide="prev">
        <span class="icon-prev"></span>
    </a>
    <a class="right carousel-control" href="#myCarousel" data-slide="next">
        <span class="icon-next"></span>
    </a>
</div>

<div class="section-colored text-center">

    <div class="container">

        <div class="row">
            <div class="col-lg-12">
                <h2>SightReader</h2>
                <p>Learn how to sight-read music and test your abilities!</p>
                <hr>
            </div>
        </div>
        <!-- /.row -->

    </div>
    <!-- /.container -->

</div>
<!-- /.section-colored -->

<div class="section">

    <div class="container">

        <p id="score"><b>Score: 0</b></p>

        <div class="row">
            <div id="game_container">
                <div id="boo"></div>
            </div>
            <div id="controls">
                <button id='start' onclick="startGame()">Start Game</button>
                <button id='stop' onclick="stopGame()" disabled>Stop Game</button>
                <button id='playC' onclick="guessNote('c')">C</button>
                <button id='playD' onclick="guessNote('d')">D</button>
                <button id='playE' onclick="guessNote('e')">E</button>
                <button id='playF' onclick="guessNote('f')">F</button>
                <button id='playG' onclick="guessNote('g')">G</button>
                <button id='playA' onclick="guessNote('a')">A</button>
                <button id='playB' onclick="guessNote('b')">B</button>
            </div>

            <audio id="audio_c1" src="../39187__jobro__piano-ff-040.wav"></audio>
            <audio id="audio_d" src="../39189__jobro__piano-ff-042.wav"></audio>
            <audio id="audio_e" src="../39191__jobro__piano-ff-044.wav"></audio>
            <audio id="audio_f" src="../39193__jobro__piano-ff-045.wav"></audio>
            <audio id="audio_g" src="../39195__jobro__piano-ff-047.wav"></audio>
            <audio id="audio_a" src="../39197__jobro__piano-ff-049.wav"></audio>
            <audio id="audio_b" src="../39199__jobro__piano-ff-051.wav"></audio>
            <audio id="audio_c2" src="../39200__jobro__piano-ff-052.wav"></audio>
        </div>
        <!-- /.row -->

    </div>
    <!-- /.container -->

</div>
<!-- /.section -->

<div class="container">

    <div class="row well">
        <div class="col-lg-8 col-md-8">
            <h4>Start learning how to read music now!</h4>
            <p>Progress through SightReader's tutorial sections and learn the basics of sight-reading music!</p>
        </div>
        <div class="col-lg-4 col-md-4">
            <a class="btn btn-lg btn-primary pull-right" href="#/tutorial1-1">Begin Tutorial</a>
        </div>
    </div>
    <!-- /.row -->

</div>
<!-- /.container -->